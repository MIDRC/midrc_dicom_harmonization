name: Validate StudyDescription Mapping Table

on:
  # Allow manual triggering
  workflow_dispatch:

  # Run on pull requests
  pull_request:
    paths:
      - 'out/StudyDescription_mapping_table.tsv'
      - 'util/analyze_in_out.py'
      - '.github/workflows/validate-mapping-table.yml'

  # Run on pushes to main when mapping table changes
  push:
    branches:
      - main
    paths:
      - 'out/StudyDescription_mapping_table.tsv'

jobs:
  validate:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: [3.8.15]

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pandas
        python --version

    - name: Validate mapping table
      id: validation
      continue-on-error: true
      run: |
        set +e
        python util/analyze_in_out.py --validate . 2>&1 | tee validation_output.txt
        exit_code=${PIPESTATUS[0]}
        echo "Validation exit code: $exit_code"
        exit $exit_code

    - name: Create issue on validation failure
      if: steps.validation.outcome == 'failure'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const validationOutput = fs.readFileSync('validation_output.txt', 'utf8');

          // Create issue title based on event type
          const eventName = context.eventName;
          let issueTitle = 'Mapping Table Validation Failed';

          if (eventName === 'pull_request') {
            issueTitle += ` in PR #${context.payload.pull_request.number}`;
          } else if (eventName === 'push') {
            const shortSha = context.sha.substring(0, 7);
            issueTitle += ` (commit ${shortSha})`;
          }

          // Create issue body with validation details
          const issueBody = `## Validation Failure

          The StudyDescription mapping table validation has failed.

          **Event**: ${eventName}
          **Workflow Run**: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}
          ${eventName === 'pull_request' ? `**Pull Request**: #${context.payload.pull_request.number}` : ''}
          ${eventName === 'push' ? `**Commit**: ${context.sha}` : ''}

          ### Validation Output

          \`\`\`
          ${validationOutput}
          \`\`\`

          ### Action Required

          Please review the validation errors above and fix the inconsistencies in the mapping table:
          - **Check 1**: Rows with same Modality/StudyDescription but different LOINC codes
          - **Check 2**: Rows with same LOINC code but different L-Long Common Names

          See [\`util/analyze_in_out.py\`](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/blob/main/util/analyze_in_out.py) for validation logic.
          `;

          // Check if there's an existing open issue
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: 'validation-failure',
            per_page: 100
          });

          const existingIssue = issues.data.find(issue =>
            issue.title.includes('Mapping Table Validation Failed')
          );

          if (existingIssue) {
            // Add a comment to existing issue
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: existingIssue.number,
              body: `## New Validation Failure\n\n${issueBody}`
            });
            console.log(`Added comment to existing issue #${existingIssue.number}`);
          } else {
            // Create new issue
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: issueTitle,
              body: issueBody,
              labels: ['validation-failure', 'bug']
            });
            console.log(`Created new issue #${issue.data.number}`);
          }

    - name: Fail workflow if validation failed
      if: steps.validation.outcome == 'failure'
      run: |
        echo "::error::Mapping table validation failed. An issue has been created with details."
        exit 1
